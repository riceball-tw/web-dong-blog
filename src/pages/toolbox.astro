---
import Base from '@/layouts/Base.astro';
import { getCollection } from 'astro:content';
import PostCard from '@/components/card/PostCard.astro';
import CardGallery from '@/components/card/CardGallery.astro';
import Footer from '@/components/app/Footer.astro';
import Navbar from '@/components/app/Navbar.astro';
import YoutubeChannels from '@/components/toolbox/YoutubeChannels.astro';

const toolboxSites = await getCollection('toolbox');
const categorizedSites = toolboxSites.reduce((categorizedData: Record<string, any[]>, site) => {
  const { data } = site;
  const { category } = data;
  return {
    ...categorizedData,
    [category]: [...(categorizedData[category] || []), data],
  };
}, {});

const categories = Object.keys(categorizedSites);
const categoriesWithQunatity = categories.map((category) => ({ [category]: categorizedSites[category]?.length }));

interface Channel { id: string; category: string }
interface Channels extends Array<Channel> {}

async function getYoutubeChannels(channels: Channels) {
  const youtubeAPIKey = import.meta.env.PUBLIC_YOUTUBEAPIKEY;
  const channelsIDs = channels.map((channel) => channel.id).join(',');
  //  YT API V3 Subscriptions.list NOT returning nextPageToken
  // https://issuetracker.google.com/issues/35176305
  // Won't fix Bug, Only Maxium 50 channels per request
  const channelBatches = channelsIDs.split(',').map((channelIDs) => channelIDs.slice(0, 50));
  const parts = ['snippet', 'brandingSettings'];
  return (
        await Promise.all(
        channelBatches.map(async (channelIDs) => {
            const youtubeRequestUrl = `https://www.googleapis.com/youtube/v3/channels?part=${parts}&id=${channelIDs}&key=${youtubeAPIKey}`;
            try {
                const res = await fetch(youtubeRequestUrl);
                if (!res.ok) throw new Error(res.statusText);
                const resJSON = await res.json();
                return resJSON.items.map((channel: any) => ({
                    id: channel.id,
                    url: `https://www.youtube.com/channel/${channel.id}`,
                    title: channel.snippet.title,
                    thumbnail: channel.snippet.thumbnails.default,
                    category: channels.find((localChannel) => channel.id === localChannel.id)?.category,
                    brandingSettings: channel.brandingSettings,
                }));
            } catch (err) {
                // eslint-disable-next-line no-console
                console.error(err);
                return [];
            }
        }),
    )
  ).flat();
}

const youtubeChannelInfos = [
  { id: 'UCQT3GwtAop6cnvTTTsKUUoQ', category: 'é–‹ç™¼' },
  { id: 'UCD00Is447lWaY04_gNTOaVA', category: 'å‰ç«¯' },
  { id: 'UCtEwVJZABCd0tels2KIpKGQ', category: 'éŠæˆ²é–‹ç™¼' },
  { id: 'UCQG40havu4kNpB4pxUDQhYQ', category: 'éŠæˆ²é–‹ç™¼' },
  { id: 'UCEL8871qFEakpqYpwBSjHNA', category: 'å‰ç«¯' },
  { id: 'UCd_lJ4zSp9wZDNyeKCWUstg', category: 'éŠæˆ²é–‹ç™¼' },
  { id: 'UCXzw-OdotBUcNA9yhuYQBwA', category: 'å‰ç«¯' },
  { id: 'UCrU33aw1k9BqTIq2yKXrmBw', category: 'å…¨ç«¯' },
  { id: 'UC-8QAzbLcRglXeN_MY9blyw', category: 'é–‹ç™¼' },
  { id: 'UCfFNverFD_Md_WDQGBBC7Zw', category: 'å‰ç«¯' },
  { id: 'UC2Xd-TjJByJyK2w1zNwY0zQ', category: 'å…¨ç«¯' },
  { id: 'UCr7GjHXlkad7hMcXMc-R3ag', category: 'é–‹ç™¼' },
  { id: 'UCZgt6AzoyjslHTC9dz0UoTw', category: 'å…¨ç«¯' },
  { id: 'UCmXVXfidLZQkppLPaATcHag', category: 'å‰ç«¯' },
  { id: 'UCnUYZLuoy1rq1aVMwx4aTzw', category: 'é–‹ç™¼è€…å·¥å…·' },
  { id: 'UCyYh-eAr74avLwOyPa1dDNg', category: 'é–‹ç™¼è€…å·¥å…·' },
  { id: 'UCe2gI9snYbRigUF0tOlYFiQ', category: 'å‰ç«¯' },
  { id: 'UC1NA1famQ2CQPJr6wxhsFYg', category: 'å‰ç«¯' },
  { id: 'UCEbS5GE-OOsvRhn21Hw_fGQ', category: 'é–‹ç™¼' },
  { id: 'UCaSCt8s_4nfkRglWCvNSDrg', category: 'é–‹ç™¼' },
  { id: 'UC7pVho4O31FyfQsZdXWejEw', category: 'å‰ç«¯' },
  { id: 'UCrsLPlwxUInDoNubOP85EWQ', category: 'é–‹ç™¼' },
  { id: 'UCMm15RFnHUvM-aSc50e7R9A', category: 'å‰ç«¯' },
  { id: 'UCEeLR5dw1gR0v3mw92ftiuw', category: 'é–‹ç™¼' },
  { id: 'UCWI-ohtRu8eEeDj93hmUsUQ', category: 'å…¨ç«¯' },
  { id: 'UCwYb4QztAKKqj5YcaTEtyrQ', category: 'å‰ç«¯' },
  { id: 'UCHa8J-xnRYOg5VuudfWpBgg', category: 'å‰ç«¯' },
  { id: 'UCrqAGUPPMOdo0jfQ6grikZw', category: 'å‰ç«¯' },
  { id: 'UC9-y-6csu5WGm29I7JiwpnA', category: 'è¨ˆç®—æ©Ÿç§‘å­¸' },
  { id: 'UCCfqyGl3nq_V0bo64CjZh8g', category: 'é–‹ç™¼' },
  { id: 'UCZ6WpfaTIYkdqpH-16ep2GQ', category: 'å‰ç«¯' },
  { id: 'UCVyRiMvfUNMA1UPlDPzG5Ow', category: 'ä½¿ç”¨è€…ä»‹é¢' },
  { id: 'UCDrekHmOnkptxq3gUU0IyfA', category: 'é–‹ç™¼' },
  { id: 'UCV4AXpDSxschk8I0sCl8JXw', category: 'å‰ç«¯' },
  { id: 'UCyIe-61Y8C4_o-zZCtO4ETQ', category: 'å‰ç«¯' },
  { id: 'UCrUL8K81R4VBzm-KOYwrcxQ', category: 'é–‹ç™¼' },
  { id: 'UCP4bf6IHJJQehibu6ai__cg', category: 'é–‹ç™¼è€…å·¥å…·' },
  { id: 'UC8butISFwT-Wl7EV0hUK0BQ', category: 'é–‹ç™¼' },
  { id: 'UCFDF_U_uoKc6MhIZPZKo5CA', category: 'å…¨ç«¯' },
  { id: 'UCO1cgjhGzsSYb1rsB4bFe4Q', category: 'é–‹ç™¼' },
  { id: 'UCvmINlrza7JHB1zkIOuXEbw', category: 'å…¨ç«¯' },
  { id: 'UCWf2ZlNsCGDS89VBF_awNvA', category: 'é–‹ç™¼è€…å·¥å…·' },
  { id: 'UCrZOiJyMbXpZ8T5snCIJaLA', category: 'é–‹ç™¼' },
  { id: 'UCmEzz-dPBVrsy4ZluSsYHDg', category: 'å‰ç«¯' },
  { id: 'UCsMoFkb0DSPIjHGFFzYH42Q', category: 'é–‹ç™¼' },
  { id: 'UC-T8W79DN6PBnzomelvqJYw', category: 'å‰ç«¯' },
  { id: 'UCvjgXvBlbQiydffZU7m1_aw', category: 'é–‹ç™¼' },
  { id: 'UCa8W2_uf81Ew6gYuw0VPSeA', category: 'ä½¿ç”¨è€…ä»‹é¢' },
  { id: 'UCVzt0Ltq6VNKRqRMrry3OIA', category: 'éŠæˆ²é–‹ç™¼' },
  { id: 'UCs5Y5_7XK8HLDX0SLNwkd3w', category: 'é–‹ç™¼è€…å·¥å…·' },
  { id: 'UC7P4OgGjFZUSUt1J472c4Ew', category: 'è¨ˆç®—æ©Ÿç§‘å­¸' },
  { id: 'UC5--wS0Ljbin1TjWQX6eafA', category: 'é–‹ç™¼' },
  { id: 'UCfzOLBT7jyHFcaTgwmnttog', category: 'ä½¿ç”¨è€…ä»‹é¢' },
  { id: 'UCUSxKiac-miugK9CDsxGS9Q', category: 'å‰ç«¯' },
  { id: 'UCrL69sErRwEyr7_p0qVCkOQ', category: 'å‰ç«¯' },
  { id: 'UCzestFrXpwSGCfcbO2pObwQ', category: 'ä½¿ç”¨è€…ä»‹é¢' },
  { id: 'UC5EU0syk1Am-c_zpOeYQXfw', category: 'ä½¿ç”¨è€…ä»‹é¢' },
  { id: 'UC-0fWjosItIOD4ThhS6oyfA', category: 'é–‹ç™¼' },
  { id: 'UCQsVmhSa4X-G3lHlUtejzLA', category: 'ä½¿ç”¨è€…ä»‹é¢' },
  { id: 'UCsBjURrPoezykLs9EqgamOA', category: 'é–‹ç™¼' },
  { id: 'UCqJ-Xo29CKyLTjn6z2XwYAw', category: 'éŠæˆ²é–‹ç™¼' },
  { id: 'UC-4nsAH5j9AIhv5tHoQSP9g', category: 'é–‹ç™¼' },
  { id: 'UCvBGFeXbBrq3W9_0oNLJREQ', category: 'ä½¿ç”¨è€…ä»‹é¢' },
  { id: 'UCzoVCacndDCfGDf41P-z0iA', category: 'é–‹ç™¼' },
  { id: 'UCWQmoLB4Fz0MoWwiCBq8WQg', category: 'é–‹ç™¼' },
  { id: 'UCJZv4d5rbIKd4QHMPkcABCw', category: 'å‰ç«¯' },
  { id: 'UCZCQ3LXtU3IUzMBQBqN69KQ', category: 'å‰ç«¯' },
  { id: 'UC7TizprGknbDalbHplROtag', category: 'å‰ç«¯' },
  { id: 'UCVTlvUkGslCV_h-nSAId8Sw', category: 'å‰ç«¯' },
  { id: 'UCgmcPHueYRarnCkihtNIRlw', category: 'å‰ç«¯' },
  { id: 'UCqSSszY8L-Qfn4HKAllnxVg', category: 'é–‹ç™¼' },
  { id: 'UClcE-kVhqyiHCcjYwcpfj9w', category: 'è³‡å®‰' },
  { id: 'UC2wNnyb3vWhOt0K6LpBrtGg', category: 'éŠæˆ²é–‹ç™¼' },
  { id: 'UC_mYaQAE6-71rjSN6CeCA-g', category: 'é–‹ç™¼' },
  { id: 'UCV3-2vJmpa4hzbjEhNMNs9w', category: 'å‰ç«¯' },
  { id: 'UCW5YeuERMmlnqo4oq8vwUpg', category: 'å‰ç«¯' },
  { id: 'UCqgU14t4ZjTqaKVTbf5ePiA', category: 'é–‹ç™¼' },
  { id: 'UCUMwY9iS8oMyWDYIe6_RmoA', category: 'é–‹ç™¼' },
  { id: 'UCaJmKxnFgEaeXr9aEnL22ew', category: 'å‰ç«¯' },
  { id: 'UCJq6AEgtWeZt7ziQ-fLKOeA', category: 'å‰ç«¯' },
  { id: 'UCczXI0u-LKlX-oBwrkKtOdg', category: 'é–‹ç™¼' },
  { id: 'UCW6MNdOsqv2E9AjQkv9we7A', category: 'è³‡å®‰' },
  { id: 'UCEwhtpXrg5MmwlH04ANpL8A', category: 'éŠæˆ²é–‹ç™¼' },
  { id: 'UCDzVUXiTr3hClI-zzCWbYzg', category: 'è¨ˆç®—æ©Ÿç§‘å­¸' },
  { id: 'UCGmR6lhKMlCkvrvb39vPtdA', category: 'å‰ç«¯' },
  { id: 'UCUdkjbeIFea0qUSgwR1CUOg', category: 'é–‹ç™¼' },
  { id: 'UCyU5wkjgQYGRB0hIHMwm2Sg', category: 'å‰ç«¯' },
  { id: 'UCpGCuiAOFIDurA-hU_p2E0w', category: 'éŠæˆ²é–‹ç™¼' },
  { id: 'UC4xKdmAXFh4ACyhpiQ_3qBw', category: 'ç”Ÿæ´»' },
  { id: 'UCxVPH8W2ayMey1-b0SY8rBQ', category: 'é–‹ç™¼' },
  { id: 'UCV0qA-eDDICsRR9rPcnG7tw', category: 'ç”Ÿæ´»' },
  { id: 'UCUyeluBRhGPCW4rPe_UvBZQ', category: 'é–‹ç™¼' },
  { id: 'UCbRP3c757lWg9M-U7TyEkXA', category: 'é–‹ç™¼' },
  { id: 'UClEEzwG7Tl3-8eY11Qytsog', category: 'å…¨ç«¯' },
  { id: 'UC29ju8bIPH5as8OGnQzwJyA', category: 'å…¨ç«¯' },
  { id: 'UCGPGirOab9EGy7VH4IwmWVQ', category: 'é–‹ç™¼' },
  { id: 'UCbfYPyITQ-7l4upoX8nvctg', category: 'è¨ˆç®—æ©Ÿç§‘å­¸' },
  { id: 'UCcf4LQogGFtYzPhq05uHE4g', category: 'è¨ˆç®—æ©Ÿç§‘å­¸' },
  { id: 'UCbAn7pVK2VIyo-UysfWGdZQ', category: 'å‰ç«¯' },
  { id: 'UC0cDihZ20PWUQzHh_hOigtA', category: 'ç”Ÿæ´»' },
  { id: 'UCa1zuotKU4Weuw_fLRnPv0A', category: 'å‰ç«¯' },
  { id: 'UC-4Ij6StciJgYzbxLyxHMPw', category: 'å‰ç«¯' },
  { id: 'UCFbNIlppjAuEX4znoulh0Cw', category: 'å‰ç«¯' },
  { id: 'UCy1Q33r6POsxGTtZcOF--Fw', category: 'å‰ç«¯' },
  { id: 'UCAzMOk7mDFug5hGlU-ilmGQ', category: 'ç”Ÿæ´»' },
  { id: 'UC0yCXVwW6FdDQGYA-3OWXxw', category: 'é–‹ç™¼' },
  { id: 'UCvYUyKg7wDj760PippmWhig', category: 'éŠæˆ²é–‹ç™¼' },
  { id: 'UCQiB10TT-sy5wdmCB6fiFlg', category: 'é–‹ç™¼' },
  { id: 'UC45xDuLSKCXhw-gtTtPV7Ew', category: 'å‰ç«¯' },
  { id: 'UC7ArpUezGLX-dZ0FTS_jVMQ', category: 'å‰ç«¯' },
  { id: 'UC1KKByu8cgQWPiKe1GZZQbg', category: 'ä½¿ç”¨è€…ä»‹é¢' },
]

const youtubeChannels = await getYoutubeChannels(youtubeChannelInfos);
---

<script>
 function refreshCategory() {
    const categoryItems = document.querySelectorAll('[data-category-item]');
    categoryItems.forEach((categoryItem) => {
      const categoryItemLink = categoryItem.querySelector('a');
      categoryItemLink?.classList.remove('before:content-[">"]');
      if (window.location.hash === '') return;
      if (categoryItemLink?.href.includes(window.location.hash)) {
        categoryItemLink?.classList.add('before:content-[">"]');
      }
    });
  }

  const nav = document.querySelector('[data-nav]');

  document.querySelector('[data-nav-close]')?.addEventListener('click', () => {
    nav?.classList.add('hidden');
  });

  document.querySelector('[data-nav-toggle]')?.addEventListener('click', () => {
    nav?.classList.toggle('md:hidden');
    nav?.classList.toggle('hidden');
  });

  window.addEventListener('hashchange', () => {
    refreshCategory();
  });

  refreshCategory();
</script>

<Base title="ç¶²é å·¥å…·ç®±" description="ç¶²è·¯ä¸Šæœ‰è¨±å¤šæ–°å¥‡æœ‰è¶£çš„ç¶²ç«™ï¼Œç¶²é å·¥å…·ç®±å°‡å”åŠ©æ‚¨è¼•é¬†æ¢ç´¢å„ç¨®å¤šå…ƒè³‡æº ğŸ‘€">
  <Navbar>
    <button data-nav-toggle
      ><svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"
        ><path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"></path></svg
      ></button
    >
  </Navbar>
  <div class="flex">
    <aside
      style=" flex: 0 0 300px;"
      data-nav
      class="fixed left-0 top-0 z-40 hidden h-full flex-col justify-between backdrop-blur-xl md:sticky md:top-[var(--mainNav-height)] md:block"
    >
      <ul class="group ml-0 divide-y divide-secondary/40 dark:divide-secondary-light/40 md:ml-4">
        <li data-category-item>
          <a
            href="#é–‹ç™¼è¨­è¨ˆç›¸é—œé »é“"
            class="inline-block w-full p-4 font-medium tracking-wider transition-opacity before:mr-2 group-hover:opacity-60 group-hover:hover:opacity-100"
            >é–‹ç™¼è¨­è¨ˆç›¸é—œé »é“<sup class="p-2">{youtubeChannelInfos.length}</sup>
          </a>
        </li>
        {
          categoriesWithQunatity.map((category) => {
            const categoryKey = Object.keys(category)[0];
            const categoryValue = Object.values(category)[0];

            return (
              <li data-category-item>
                <a
                  class="inline-block w-full p-4 font-medium tracking-wider  transition-opacity before:mr-2 group-hover:opacity-60 group-hover:hover:opacity-100"
                  href={`#${categoryKey}`}
                >
                  <span>{categoryKey}</span>
                  <sup class="p-2">{categoryValue}</sup>
                </a>
              </li>
            );
          })
        }
      </ul>
    </aside>
    <main class="flex w-full min-w-0 flex-col gap-4">
      <div class="mt-0 md:mt-[var(--mainNav-height)]">
        <section class="mx-auto my-16 flex px-4" style="max-width: 1450px;">
          <h1 class="mx-auto text-center text-3xl font-bold md:text-5xl">
            ç¶²è·¯ä¸Šæœ‰è¨±å¤š<span class="text-secondary dark:text-secondary-light">æ–°å¥‡æœ‰è¶£çš„ç¶²ç«™</span>ï¼Œ<span
              class="text-secondary dark:text-secondary-light">ç¶²é å·¥å…·ç®±</span
            >å°‡å”åŠ©æ‚¨è¼•é¬†æ¢ç´¢å„ç¨®å¤šå…ƒè³‡æº ğŸ‘€
          </h1>
        </section>
        <section class="flex flex-col px-4">
          <h2 id="é–‹ç™¼è¨­è¨ˆç›¸é—œé »é“" class="py-8 text-xl font-bold tracking-widest before:mr-2 md:pb-16">
            <a href="#é–‹ç™¼è¨­è¨ˆç›¸é—œé »é“">é–‹ç™¼è¨­è¨ˆç›¸é—œé »é“</a>
          </h2>

          <YoutubeChannels youtubeChannels={youtubeChannels} />
        </section>
        {
          Object.entries(categorizedSites).map((siteCategories) => (
              <section class=" flex flex-col px-4">
                {siteCategories.map((group) => {
                  if (typeof group === 'string')
                    return (
                      <h2
                        id={group}
                        class="py-8 text-xl font-bold tracking-widest before:mr-2 target:before:content-['>'] md:pb-16"
                      >
                        <a href={`#${group}`}>{`${group}`}</a>
                      </h2>
                    );

                  return (
                    <CardGallery>
                      {group.map((site) => <PostCard post={site} />)}
                    </CardGallery>
                  );
                })}
              </section>
            ))
        }
        <section class="mx-auto my-16 flex px-4" style="max-width: 1450px;">
          <h2 style="max-width: 900px" class="mx-auto text-center text-3xl font-bold md:text-5xl">
            ä½ æœ‰<span class="text-secondary dark:text-secondary-light">æƒ³æ¨è–¦</span>æˆ–<span
              class="text-secondary dark:text-secondary-light">æƒ³ä¿®æ­£</span
            >çš„å…§å®¹å—ï¼Ÿ æ­¡è¿<a class="underline" href="https://github.com/riceball-tw/astro-blog">ç™¼å€‹ PR</a>æˆ–å‘ŠçŸ¥æˆ‘ ğŸ™Œ
          </h2>
        </section>
      </div>
    </main>
  </div>
  <Footer />
</Base>
